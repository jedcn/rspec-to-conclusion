#!/usr/bin/env node

require('shelljs/global');
var _ = require('underscore');

function verifyPreConditions() {
  var ok = true;
  if (!which('rspec')) {
    console.log('Ack! I can\'t rspec without `rspec`');
    console.log('Do you see rspec when you type `which rspec`?');
    ok = false;
  }
  return ok;
}

function runSpecs(runNumber) {
  var resultsFile = 'results-' + runNumber + '.json';
  var command = 'rspec --format json --out ' + resultsFile + ' spec';
  var runFailed = exec(command).code !== 0;
  var cwd = process.cwd();
  var parsedResults = require(cwd + '/' + resultsFile);
  return parsedResults;
}

function runAndSummarize(runNumber) {
  var successes = {},
      failures = {},
      pending = {},
      results = runSpecs(runNumber);

  _.each(results.examples, function(result) {
    var resultKey = result.file_path + ':' + result.line_number;
    if (result.status == 'passed') {
      successes[resultKey] = result;
    } else if (result.status == 'failed') {
      failures[resultKey] = result;
    } else {
      pending[resultKey] = result;
    }
  });
  return {
    successes: successes,
    failures: failures,
    pending: pending
  };
}

//
// Doing the actual run..
//
if (!verifyPreConditions()) {
  exit(1);
}

var runNumber,
    maximumRuns = 3;

for(runNumber = 1; runNumber <= maximumRuns; runNumber++) {
  console.log("RunNumber: " + runNumber);
  console.log("");

  var runResult = runAndSummarize(runNumber);

  var tableRows = [];
  tableRows.push(['File Name and Line Number', 'Result', 'Time']);

  _.mapObject(runResult.successes, function(result, fileNameAndLineNumber) {
    tableRows.push([fileNameAndLineNumber, 'PASSED', result.run_time]);
  });

  _.mapObject(runResult.failures, function(result, fileNameAndLineNumber) {
    tableRows.push([fileNameAndLineNumber, 'FAILED', result.run_time]);
  });

  var table = require('gfm-table');
  console.log(table(tableRows));

  console.log("");
}
